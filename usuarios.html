<!DOCTYPE html>
<html lang="en">
<head runat="server">
    <title>Usuarios</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />

    <link href="Content/datatables.boostrap.css" rel="stylesheet" type="text/css"/>
    <link rel="stylehseet" type="text/css" href="//cdn.datatables.net/responsive/1.0.1/css/dataTables.responsive.css" />
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Custom Fonts -->
    <link href="Content/font-awesome.min.css" rel="stylesheet" type="text/css"/>

    <link href="Content/pnotify.custom.min.css" rel="stylesheet" />

    <link href="Content/site.css" rel="stylesheet" />
    <link href="Content/sweetalert.css" rel="stylesheet" />
</head>
<body class="bodyFixed">
<div class="container" id="loading">
</div>

<div class="container" id="principal">
    <!-- encabezado -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">

                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false" style="margin-right:70px;">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="Inicio.html" data-bind="text: nombreInstitucion"></a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="Inicio.html"><i class="fa fa-home"></i> Inicio</a></li>
                    <li><a href="login.html" id="ancoreSesion"><i class="fa fa-sign-in"></i> Iniciar Sesión</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Administración <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="usuarios.html">Usuarios</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="ListarInstitucion.html">Intituciones</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="ListarRendicion.html">Rendiciones</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="ListarDocumento.html">Documentos de Usuario</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="ListarCalendario.html">Calendario</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>


    </nav>

    <nav class="navbar navbar-default navbar-fixed-bottom">
        <div class="container-fluid">
            <a href="#"><i class="fa fa-user-circle"></i>&nbsp;<span data-bind="text: nombreCompleto"></span></a>
            <a href="#" class="pull-right"><i class="fa fa-calendar"></i>&nbsp;<span data-bind="text: birthDay"></span></a>
        </div>
    </nav>

    <div class="col-xs-12 page-header">
        <h3 class="col-xs-9 col-md-10">Listado <small>de Usuarios</small></h3>
        <a href="crearModificarUsuario.html?id=0&ELIMINADO=0" class="col-xs-3 col-md-2" data-bind="visible: shouldShowMessage"><i class="fa fa-5x fa-plus-circle pull-right" data-toggle="tooltip" data-placement="left" title="Crear Nuevo Usuario"></i></a>
    </div>

    <table id="proposals" class="table table-striped table-bordered">
        <thead>
        <tr>
            <th data-bind="visible: shouldShowMessage"></th>
            <th>Nombre</th>
            <th class="hidden-xs">Usuario</th>
            <th class="hidden-xs">Rol</th>
        </tr>
        </thead>
        <tbody>
        <!-- ko foreach: proposals() -->
        <tr>
            <td data-bind="visible: shouldShowMessage"><a data-bind="    attr: { href: $data.Url }, visible: shouldShowMessage"><i class="fa fa-2x fa-edit"></i></a>
                <a data-bind="attr: { href: $data.UrlEliminar }, visible: shouldShowMessage"><i class="fa fa-2x fa-trash"></i></a>
            </td>
            <td><span data-bind="text: $data.NombreCompleto"></span></td>
            <td class="hidden-xs"><span data-bind="text: $data.NombreUsuario"></span></td>
            <td class="hidden-xs"><span data-bind="text: $data.Rol"></span></td>
        </tr>
        <!-- /ko -->
        </tbody>
    </table>


</div>

<!-- Include ALL THE SCRIPTS -->

<!-- jQuery http://jquery.com -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<!-- Bootstrap http://getbootstrap.com -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<!-- KnockoutJS http://knockoutjs.com/ -->
<script src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.2.0/knockout-min.js"></script>

<!-- KnockoutJS Mapping http://knockoutjs.com/documentation/plugins-mapping.html -->
<script src="//cdnjs.cloudflare.com/ajax/libs/knockout.mapping/2.4.1/knockout.mapping.min.js"></script>

<!-- jQuery DataTables http://datatables.net -->
<script src="//cdn.datatables.net/1.10.2/js/jquery.dataTables.js"></script>

<!-- Bootstrap DataTables http://www.datatables.net/manual/styling/bootstrap -->
<script src="//cdn.datatables.net/plug-ins/a5734b29083/integration/bootstrap/3/dataTables.bootstrap.js"></script>

<!-- Responsive DataTables http://www.datatables.net/extensions/responsive/ -->
<script src="//cdn.datatables.net/responsive/1.0.1/js/dataTables.responsive.js"></script>

<script src="Scripts/sweetalert.js"></script>

<script src="Scripts/pnotify.custom.min.js"></script>
<script src="Scripts/moment.js"></script>

<script>
    $(function () {

        $('#principal').hide();
        $('#loading').show();


        if (sessionStorage != null) {

            if (sessionStorage.getItem("Id") != null) {
                $('#ancoreSesion').html('<i class="fa fa-close"></i> Cerrar Sesión');
            }
            else {
                $('#ancoreSesion').html('<i class="fa fa-sign-in"></i> Iniciar Sesión');
                window.location.href = "login.html";
                return;
            }
        }
        else {
            window.location.href = "login.html";
        }

        $('#ancoreSesion').on('click', function () {
            if ($('#ancoreSesion').html() == '<i class="fa fa-close"></i> Cerrar Sesión') {
                //acá debe direccionarlo directamente al login y vaciar la variable de session
                sessionStorage.clear();
                window.location.href = "login.html";
                return;
            }
            else {
                //directo al login
                window.location.href = "login.html";
            }


        });

        $('[data-toggle="tooltip"]').tooltip()
        // knockout view model
        function ViewModel(data) {
            var self = this;
            nombreCompleto = ko.observable(sessionStorage.getItem("NombreCompleto"));
            nombreInstitucion = ko.observable(sessionStorage.getItem("NombreInstitucion"));
            self.birthDay = ko.observable(moment(new Date()).format("DD-MM-YYYY"));
            // knockout mapping JSON data to view model

            if (sessionStorage.getItem("RolId") == '1')
                shouldShowMessage = ko.observable(true);
            else
                shouldShowMessage = ko.observable(false);


            ko.mapping.fromJS(data, {}, self);
            eliminar = function (data, event) {
                var target = event.target || event.srcElement;

                if (target.nodeType == 3) // defeat Safari bug
                    target = target.parentNode;

                var idEliminar = data.Id;

                swal({
                    title: "Eliminar",
                    text: "¿Está seguro de eliminar a este usuario?",
                    type: "info",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    customClass: 'sweetalert-xs',
                    showLoaderOnConfirm: true
                }, function () {
                    setTimeout(function () {


                        $.ajax({
                            url: "http://localhost:48909/api/ObtenerUsuario",
                            type: "DELETE",
                            data: ko.toJSON({ IdUsuario: idEliminar }),
                            contentType: "application/json",
                            dataType: "json",
                            success: function (dataF) {
                                //ok
                                var self = this;

                                swal("Eliminado con éxito!");

                                window.location.href = "usuarios.html";

                                //swal("Eliminado con éxito!");
                            },
                            error: function (error) {
                                if (error.status.toString() == "500") {
                                    //getNotify('error', 'Error', 'Error de Servidor!');
                                    swal("Error de Servidor");
                                }
                                else {
                                    //getNotify('error', 'Error', 'Error de Servidor!');
                                    swal("Error de Servidor");
                                }
                            }
                        });

                        //swal("Ajax request finished!");


                    }, 2000);
                });
            }
        }
        // get data - sample data from Donors Choose API
        $.getJSON("http://localhost:48909/api/ListarUsuarios?instId=" + sessionStorage.getItem("InstId"), function (data) {
            // bind the data
            elem = document.getElementById('principal');
            //ko.cleanNode(elem);
            //ko.applyBindings(new PersonViewModel(data, dataR, dataCC, self.roles), elem);
            ko.applyBindings(new ViewModel(data), elem);
            // apply DataTables magic
            $("#proposals").DataTable({
                responsive: true,
                language: {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_ registros",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "Ningún dato disponible en esta tabla",
                    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sInfoPostFix": "",
                    "sSearch": "Buscar:",
                    "sUrl": "",
                    "bDestroy": true,
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": "Primero",
                        "sLast": "Último",
                        "sNext": "Siguiente",
                        "sPrevious": "Anterior"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    }
                }
            });
            $('#principal').show();
            $('#loading').hide();
        });

        function getNotify(type, title, message) {
            if (type == 'error') {
                new PNotify({
                    title: title,
                    text: message,
                    type: 'error'
                });
            }
            if (type == 'success') {
                new PNotify({
                    title: title,
                    text: message,
                    icon: 'glyphicon glyphicon-ok'
                });
            }
        }



    });

    //$(window).load(function () {
    //    // Una vez se cargue al completo la página desaparecerá el div "cargando"
    //    $('#principal').show();
    //    $('#loading').hide();
    //});
</script>
</body>
</html>